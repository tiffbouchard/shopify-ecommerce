{"version":3,"sources":["../../server/hot-reloader.ts"],"names":["renderScriptError","res","error","verbose","setHeader","code","message","statusCode","end","console","stack","addCorsSupport","req","isApiRoute","url","match","API_ROUTE","preflight","headers","origin","method","writeHead","matchNextPageBundleRequest","findEntryModule","issuer","erroredPages","compilation","failedPages","errors","entryModule","name","enhancedName","push","HotReloader","constructor","dir","config","pagesDir","buildId","previewProps","middlewares","webpackHotMiddleware","stats","serverStats","clientError","serverError","serverPrevDocumentHash","prevChunkNames","onDemandEntries","watcher","run","parsedUrl","handlePageBundleRequest","pageBundleRes","parsedPageBundleUrl","pathname","params","page","path","join","BLOCKED_PAGES","indexOf","ensurePage","finished","getCompilationErrors","length","fn","Promise","resolve","reject","err","clean","distDir","getWebpackConfig","pagePaths","all","pageExtensions","pages","filter","i","entrypoints","additionalClientEntrypoints","CLIENT_STATIC_FILES_RUNTIME_AMP","NEXT_PROJECT_ROOT_DIST_CLIENT","replace","CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH","require","dev","isServer","client","server","start","configs","defaultEntry","entry","args","isClientCompilation","Object","keys","entries","map","serverBundlePath","clientBundlePath","absolutePagePath","pageExists","status","BUILDING","pageLoaderOpts","multiCompiler","compilers","hooks","failed","tap","done","documentChunk","namedChunks","get","warn","hash","send","chunkNames","Set","addedPages","diff","removedPages","size","addedPage","removedPage","WebpackHotMiddleware","booted","watch","watchOptions","_err","middleware","rootDirectory","stop","close","normalizedPage","hasErrors","action","publish","data","a","b","v","has"],"mappings":"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","sourcesContent":["import { getOverlayMiddleware } from '@next/react-dev-overlay/lib/middleware'\nimport { NextHandleFunction } from 'connect'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { WebpackHotMiddleware } from './hot-middleware'\nimport { join, relative as relativePath } from 'path'\nimport { UrlObject } from 'url'\nimport webpack from 'webpack'\nimport { createEntrypoints, createPagesMapping } from '../build/entries'\nimport { watchCompilers } from '../build/output'\nimport getBaseWebpackConfig from '../build/webpack-config'\nimport { API_ROUTE, NEXT_PROJECT_ROOT_DIST_CLIENT } from '../lib/constants'\nimport { recursiveDelete } from '../lib/recursive-delete'\nimport {\n  BLOCKED_PAGES,\n  CLIENT_STATIC_FILES_RUNTIME_AMP,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n} from '../next-server/lib/constants'\nimport { __ApiPreviewProps } from '../next-server/server/api-utils'\nimport { route } from '../next-server/server/router'\nimport errorOverlayMiddleware from './lib/error-overlay-middleware'\nimport { findPageFile } from './lib/find-page-file'\nimport onDemandEntryHandler, {\n  entries,\n  BUILDING,\n} from './on-demand-entry-handler'\nimport {\n  denormalizePagePath,\n  normalizePathSep,\n} from '../next-server/server/normalize-page-path'\nimport getRouteFromEntrypoint from '../next-server/server/get-route-from-entrypoint'\nimport { isWriteable } from '../build/is-writeable'\nimport { ClientPagesLoaderOptions } from '../build/webpack/loaders/next-client-pages-loader'\nimport { stringify } from 'querystring'\n\nexport async function renderScriptError(\n  res: ServerResponse,\n  error: Error,\n  { verbose = true } = {}\n) {\n  // Asks CDNs and others to not to cache the errored page\n  res.setHeader(\n    'Cache-Control',\n    'no-cache, no-store, max-age=0, must-revalidate'\n  )\n\n  if (\n    (error as any).code === 'ENOENT' ||\n    error.message === 'INVALID_BUILD_ID'\n  ) {\n    res.statusCode = 404\n    res.end('404 - Not Found')\n    return\n  }\n\n  if (verbose) {\n    console.error(error.stack)\n  }\n  res.statusCode = 500\n  res.end('500 - Internal Error')\n}\n\nfunction addCorsSupport(req: IncomingMessage, res: ServerResponse) {\n  const isApiRoute = req.url!.match(API_ROUTE)\n  // API routes handle their own CORS headers\n  if (isApiRoute) {\n    return { preflight: false }\n  }\n\n  if (!req.headers.origin) {\n    return { preflight: false }\n  }\n\n  res.setHeader('Access-Control-Allow-Origin', req.headers.origin)\n  res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET')\n  // Based on https://github.com/primus/access-control/blob/4cf1bc0e54b086c91e6aa44fb14966fa5ef7549c/index.js#L158\n  if (req.headers['access-control-request-headers']) {\n    res.setHeader(\n      'Access-Control-Allow-Headers',\n      req.headers['access-control-request-headers'] as string\n    )\n  }\n\n  if (req.method === 'OPTIONS') {\n    res.writeHead(200)\n    res.end()\n    return { preflight: true }\n  }\n\n  return { preflight: false }\n}\n\nconst matchNextPageBundleRequest = route(\n  '/_next/static/chunks/pages/:path*.js(\\\\.map|)'\n)\n\n// Recursively look up the issuer till it ends up at the root\nfunction findEntryModule(issuer: any): any {\n  if (issuer.issuer) {\n    return findEntryModule(issuer.issuer)\n  }\n\n  return issuer\n}\n\nfunction erroredPages(compilation: webpack.compilation.Compilation) {\n  const failedPages: { [page: string]: any[] } = {}\n  for (const error of compilation.errors) {\n    if (!error.origin) {\n      continue\n    }\n\n    const entryModule = findEntryModule(error.origin)\n    const { name } = entryModule\n    if (!name) {\n      continue\n    }\n\n    // Only pages have to be reloaded\n    if (!getRouteFromEntrypoint(name)) {\n      continue\n    }\n\n    const enhancedName = getRouteFromEntrypoint(name)\n\n    if (!enhancedName) {\n      continue\n    }\n\n    if (!failedPages[enhancedName]) {\n      failedPages[enhancedName] = []\n    }\n\n    failedPages[enhancedName].push(error)\n  }\n\n  return failedPages\n}\n\nexport default class HotReloader {\n  private dir: string\n  private buildId: string\n  private middlewares: any[]\n  private pagesDir: string\n  private webpackHotMiddleware: (NextHandleFunction & any) | null\n  private config: any\n  private stats: webpack.Stats | null\n  private serverStats: webpack.Stats | null\n  private clientError: Error | null = null\n  private serverError: Error | null = null\n  private serverPrevDocumentHash: string | null\n  private prevChunkNames?: Set<any>\n  private onDemandEntries: any\n  private previewProps: __ApiPreviewProps\n  private watcher: any\n\n  constructor(\n    dir: string,\n    {\n      config,\n      pagesDir,\n      buildId,\n      previewProps,\n    }: {\n      config: object\n      pagesDir: string\n      buildId: string\n      previewProps: __ApiPreviewProps\n    }\n  ) {\n    this.buildId = buildId\n    this.dir = dir\n    this.middlewares = []\n    this.pagesDir = pagesDir\n    this.webpackHotMiddleware = null\n    this.stats = null\n    this.serverStats = null\n    this.serverPrevDocumentHash = null\n\n    this.config = config\n    this.previewProps = previewProps\n  }\n\n  public async run(\n    req: IncomingMessage,\n    res: ServerResponse,\n    parsedUrl: UrlObject\n  ): Promise<{ finished?: true }> {\n    // Usually CORS support is not needed for the hot-reloader (this is dev only feature)\n    // With when the app runs for multi-zones support behind a proxy,\n    // the current page is trying to access this URL via assetPrefix.\n    // That's when the CORS support is needed.\n    const { preflight } = addCorsSupport(req, res)\n    if (preflight) {\n      return {}\n    }\n\n    // When a request comes in that is a page bundle, e.g. /_next/static/<buildid>/pages/index.js\n    // we have to compile the page using on-demand-entries, this middleware will handle doing that\n    // by adding the page to on-demand-entries, waiting till it's done\n    // and then the bundle will be served like usual by the actual route in server/index.js\n    const handlePageBundleRequest = async (\n      pageBundleRes: ServerResponse,\n      parsedPageBundleUrl: UrlObject\n    ): Promise<{ finished?: true }> => {\n      const { pathname } = parsedPageBundleUrl\n      const params: { path: string[] } | null = matchNextPageBundleRequest(\n        pathname\n      )\n      if (!params) {\n        return {}\n      }\n\n      const page = denormalizePagePath(`/${params.path.join('/')}`)\n      if (page === '/_error' || BLOCKED_PAGES.indexOf(page) === -1) {\n        try {\n          await this.ensurePage(page)\n        } catch (error) {\n          await renderScriptError(pageBundleRes, error)\n          return { finished: true }\n        }\n\n        const errors = await this.getCompilationErrors(page)\n        if (errors.length > 0) {\n          await renderScriptError(pageBundleRes, errors[0], { verbose: false })\n          return { finished: true }\n        }\n      }\n\n      return {}\n    }\n\n    const { finished } = await handlePageBundleRequest(res, parsedUrl)\n\n    for (const fn of this.middlewares) {\n      await new Promise((resolve, reject) => {\n        fn(req, res, (err: Error) => {\n          if (err) return reject(err)\n          resolve()\n        })\n      })\n    }\n\n    return { finished }\n  }\n\n  private async clean(): Promise<void> {\n    return recursiveDelete(join(this.dir, this.config.distDir), /^cache/)\n  }\n\n  private async getWebpackConfig() {\n    const pagePaths = await Promise.all([\n      findPageFile(this.pagesDir, '/_app', this.config.pageExtensions),\n      findPageFile(this.pagesDir, '/_document', this.config.pageExtensions),\n    ])\n\n    const pages = createPagesMapping(\n      pagePaths.filter((i) => i !== null) as string[],\n      this.config.pageExtensions\n    )\n    const entrypoints = createEntrypoints(\n      pages,\n      'server',\n      this.buildId,\n      this.previewProps,\n      this.config,\n      []\n    )\n\n    let additionalClientEntrypoints: { [file: string]: string } = {}\n    additionalClientEntrypoints[CLIENT_STATIC_FILES_RUNTIME_AMP] =\n      `./` +\n      relativePath(\n        this.dir,\n        join(NEXT_PROJECT_ROOT_DIST_CLIENT, 'dev', 'amp-dev')\n      ).replace(/\\\\/g, '/')\n\n    additionalClientEntrypoints[\n      CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH\n    ] = require.resolve(`@next/react-refresh-utils/runtime`)\n\n    return Promise.all([\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: false,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        entrypoints: { ...entrypoints.client, ...additionalClientEntrypoints },\n      }),\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: true,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        entrypoints: entrypoints.server,\n      }),\n    ])\n  }\n\n  public async start(): Promise<void> {\n    await this.clean()\n\n    const configs = await this.getWebpackConfig()\n\n    for (const config of configs) {\n      const defaultEntry = config.entry\n      config.entry = async (...args) => {\n        // @ts-ignore entry is always a functon\n        const entrypoints = await defaultEntry(...args)\n\n        const isClientCompilation = config.name === 'client'\n\n        await Promise.all(\n          Object.keys(entries).map(async (page) => {\n            if (isClientCompilation && page.match(API_ROUTE)) {\n              return\n            }\n            const {\n              serverBundlePath,\n              clientBundlePath,\n              absolutePagePath,\n            } = entries[page]\n            const pageExists = await isWriteable(absolutePagePath)\n            if (!pageExists) {\n              // page was removed\n              delete entries[page]\n              return\n            }\n\n            entries[page].status = BUILDING\n            const pageLoaderOpts: ClientPagesLoaderOptions = {\n              page,\n              absolutePagePath,\n            }\n\n            entrypoints[\n              isClientCompilation ? clientBundlePath : serverBundlePath\n            ] = isClientCompilation\n              ? `next-client-pages-loader?${stringify(pageLoaderOpts)}!`\n              : absolutePagePath\n          })\n        )\n\n        return entrypoints\n      }\n    }\n\n    const multiCompiler = webpack(configs)\n\n    watchCompilers(multiCompiler.compilers[0], multiCompiler.compilers[1])\n\n    // This plugin watches for changes to _document.js and notifies the client side that it should reload the page\n    multiCompiler.compilers[1].hooks.failed.tap(\n      'NextjsHotReloaderForServer',\n      (err: Error) => {\n        this.serverError = err\n        this.serverStats = null\n      }\n    )\n    multiCompiler.compilers[1].hooks.done.tap(\n      'NextjsHotReloaderForServer',\n      (stats) => {\n        this.serverError = null\n        this.serverStats = stats\n\n        const { compilation } = stats\n\n        // We only watch `_document` for changes on the server compilation\n        // the rest of the files will be triggered by the client compilation\n        const documentChunk = compilation.namedChunks.get('pages/_document')\n        // If the document chunk can't be found we do nothing\n        if (!documentChunk) {\n          console.warn('_document.js chunk not found')\n          return\n        }\n\n        // Initial value\n        if (this.serverPrevDocumentHash === null) {\n          this.serverPrevDocumentHash = documentChunk.hash\n          return\n        }\n\n        // If _document.js didn't change we don't trigger a reload\n        if (documentChunk.hash === this.serverPrevDocumentHash) {\n          return\n        }\n\n        // Notify reload to reload the page, as _document.js was changed (different hash)\n        this.send('reloadPage')\n        this.serverPrevDocumentHash = documentChunk.hash\n      }\n    )\n\n    multiCompiler.compilers[0].hooks.failed.tap(\n      'NextjsHotReloaderForClient',\n      (err: Error) => {\n        this.clientError = err\n        this.stats = null\n      }\n    )\n    multiCompiler.compilers[0].hooks.done.tap(\n      'NextjsHotReloaderForClient',\n      (stats) => {\n        this.clientError = null\n        this.stats = stats\n\n        const { compilation } = stats\n        const chunkNames = new Set(\n          [...compilation.namedChunks.keys()].filter(\n            (name) => !!getRouteFromEntrypoint(name)\n          )\n        )\n\n        if (this.prevChunkNames) {\n          // detect chunks which have to be replaced with a new template\n          // e.g, pages/index.js <-> pages/_error.js\n          const addedPages = diff(chunkNames, this.prevChunkNames!)\n          const removedPages = diff(this.prevChunkNames!, chunkNames)\n\n          if (addedPages.size > 0) {\n            for (const addedPage of addedPages) {\n              const page = getRouteFromEntrypoint(addedPage)\n              this.send('addedPage', page)\n            }\n          }\n\n          if (removedPages.size > 0) {\n            for (const removedPage of removedPages) {\n              const page = getRouteFromEntrypoint(removedPage)\n              this.send('removedPage', page)\n            }\n          }\n        }\n\n        this.prevChunkNames = chunkNames\n      }\n    )\n\n    this.webpackHotMiddleware = new WebpackHotMiddleware(\n      multiCompiler.compilers[0]\n    )\n\n    let booted = false\n\n    this.watcher = await new Promise((resolve) => {\n      const watcher = multiCompiler.watch(\n        // @ts-ignore webpack supports an array of watchOptions when using a multiCompiler\n        configs.map((config) => config.watchOptions!),\n        // Errors are handled separately\n        (_err: any) => {\n          if (!booted) {\n            booted = true\n            resolve(watcher)\n          }\n        }\n      )\n    })\n\n    this.onDemandEntries = onDemandEntryHandler(this.watcher, multiCompiler, {\n      pagesDir: this.pagesDir,\n      pageExtensions: this.config.pageExtensions,\n      ...(this.config.onDemandEntries as {\n        maxInactiveAge: number\n        pagesBufferLength: number\n      }),\n    })\n\n    this.middlewares = [\n      // must come before hotMiddleware\n      this.onDemandEntries.middleware,\n      this.webpackHotMiddleware.middleware,\n      errorOverlayMiddleware({ dir: this.dir }),\n      getOverlayMiddleware({\n        rootDirectory: this.dir,\n        stats: () => this.stats,\n        serverStats: () => this.serverStats,\n      }),\n    ]\n  }\n\n  public async stop(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.watcher.close((err: any) => (err ? reject(err) : resolve()))\n    })\n  }\n\n  public async getCompilationErrors(page: string) {\n    const normalizedPage = normalizePathSep(page)\n\n    if (this.clientError || this.serverError) {\n      return [this.clientError || this.serverError]\n    } else if (this.stats?.hasErrors()) {\n      const { compilation } = this.stats\n      const failedPages = erroredPages(compilation)\n\n      // If there is an error related to the requesting page we display it instead of the first error\n      if (\n        failedPages[normalizedPage] &&\n        failedPages[normalizedPage].length > 0\n      ) {\n        return failedPages[normalizedPage]\n      }\n\n      // If none were found we still have to show the other errors\n      return this.stats.compilation.errors\n    }\n\n    return []\n  }\n\n  private send(action: string, ...args: any[]): void {\n    this.webpackHotMiddleware!.publish({ action, data: args })\n  }\n\n  public async ensurePage(page: string) {\n    // Make sure we don't re-build or dispose prebuilt pages\n    if (page !== '/_error' && BLOCKED_PAGES.indexOf(page) !== -1) {\n      return\n    }\n    if (this.serverError || this.clientError) {\n      return Promise.reject(this.serverError || this.clientError)\n    }\n    return this.onDemandEntries.ensurePage(page)\n  }\n}\n\nfunction diff(a: Set<any>, b: Set<any>) {\n  return new Set([...a].filter((v) => !b.has(v)))\n}\n"]}